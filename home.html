<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستەمی غیاب و مۆڵەت - لیوای ١٨ فەوجی ٣</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #e74c3c;
            --accent: #f39c12;
            --light: #ecf0f1;
            --dark: #1a252f;
            --leave: #27ae60;
            --delete: #c0392b;
            --bg-color: #ffffff;
            --text-color: #1a252f;
            --card-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        
        /* Dark theme variables */
        [data-theme="dark"] {
            --primary: #4da6ff;
            --light: #2c3e50;
            --dark: #f8f9fa;
            --bg-color: #1a252f;
            --text-color: #f0f4f8;
            --card-bg: #2c3e50;
            --border-color: #3e5469;
            --table-header-bg: #1e2a3a;
            --hover-bg: #34495e;
            --input-bg: #2c3e50;
            --input-text: #ffffff;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 1rem 1.5rem;
            border-bottom: 5px solid var(--accent);
        }

        .header-logo {
            height: 150px;
            width: auto;
            border-radius: 8px;
        }

        .header-text {
            flex-grow: 1;
            text-align: center;
        }
        
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            background-color: var(--card-bg);
            border-radius: 5px 5px 0 0;
            margin-left: 0.5rem;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }
        
        .tab.active {
            background-color: var(--card-bg);
            font-weight: bold;
            color: var(--primary);
            border-bottom: 1px solid var(--card-bg);
            margin-bottom: -1px;
        }
        
        /* Profile Button */
        .profile-btn-container {
            position: absolute;
            left: 20px;
        }
        
        /* Profile Overlay */
        .profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .profile-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .profile-container {
            background: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            border: 1px solid var(--border-color);
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .profile-pic-container {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin-left: 1.5rem;
            border: 3px solid var(--light);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .profile-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--accent);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .profile-upload:hover {
            background: var(--primary);
            transform: scale(1.1);
        }
        
        .profile-upload input[type="file"] {
            display: none;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            color: var(--primary);
        }
        
        .profile-role {
            color: #7f8c8d;
            margin: 0;
        }
        
        .profile-sections {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }
        
        .profile-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
        }
        
        .profile-tab:hover, .profile-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        
        .profile-content {
            display: none;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 8px;
            margin: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .profile-content.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            flex: 1;
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Tajawal', sans-serif;
            background-color: var(--input-bg, var(--card-bg));
            color: var(--input-text, var(--text-color));
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(77, 166, 255, 0.2);
            outline: none;
        }
        
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .backup-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .backup-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid #eee;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .backup-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .backup-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 1rem;
        }
        
        .success-message {
            color: #27ae60;
            margin-top: 1rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dark mode icon transformation */
        [data-theme="dark"] .theme-icon {
            transform: rotate(180deg);
        }
        
        /* Dark mode specific styles */
        [data-theme="dark"] .form-container,
        [data-theme="dark"] .tab,
        [data-theme="dark"] .profile-container,
        [data-theme="dark"] .profile-content,
        [data-theme="dark"] table {
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] {
            --scrollbar-track: #1a252f;
            --scrollbar-thumb: #3e5469;
            --scrollbar-thumb-hover: #4d6377;
        }
        
        /* Custom scrollbar for dark mode */
        [data-theme="dark"]::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        [data-theme="dark"]::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        
        [data-theme="dark"]::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        
        [data-theme="dark"]::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }
        
        /* Better contrast for form placeholders */
        [data-theme="dark"] ::placeholder {
            color: #a0aec0;
            opacity: 1;
        }
        
        /* Better contrast for disabled elements */
        [data-theme="dark"] :disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .form-container {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .icon-btn {
            width: auto;
            min-width: 42px;
            padding: 0 12px;
            height: 38px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--primary);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 10px;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .icon-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: transparent;
        }
        
        .icon-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Theme icon styling */
        .theme-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        
        .theme-text {
            display: inline-block;
            margin-right: 8px;
            font-size: 0.9rem;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s ease;
        }
        
        /* Light mode specific styles */
        :not([data-theme="dark"]) .icon-btn {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #f39c12; /* Orange color for sun in light mode */
            box-shadow: 3px 3px 6px #d9d9d9, 
                        -3px -3px 6px #ffffff;
            width: auto;
            padding: 0 12px;
        }
        
        :not([data-theme="dark"]) .icon-btn:hover {
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            color: #e67e22; /* Darker orange on hover */
        }
        
        .btn:hover {
            background-color: var(--dark);
        }
        
        .btn-print {
            background-color: #607d8b;
        }
        
        .btn-leave {
            background-color: var(--leave);
        }
        
        .btn-delete {
            background-color: var(--delete);
        }
        
        .btn-edit {
            background-color: var(--accent);
        }
        
        .btn-print:hover {
            background-color: #e74c3c;
        }
        
        /* Counter badge animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #totalSoldiersCounter {
            transition: all 0.3s ease;
        }
        
        #totalSoldiersCounter.updated {
            animation: pulse 0.5s ease-in-out;
            background-color: #3b82f6 !important;
        }
        
        .btn-leave:hover {
            background-color: #219653;
        }
        
        .btn-delete:hover {
            background-color: #96281b;
        }
        
        .btn-edit:hover {
            background-color: #e67e22;
        }
        
        .records-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }
        
        th, td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        th {
            background-color: var(--table-header-bg, var(--card-bg));
            font-weight: bold;
            border-bottom: 2px solid var(--border-color);
            color: #ffffff;
        }
        
        tr:hover {
            background-color: var(--hover-bg, rgba(0, 0, 0, 0.02));
        }
        
        .badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .badge-absence {
            background-color: #ffecec;
            color: var(--secondary);
        }
        
        .badge-leave {
            background-color: #e8f5e9;
            color: var(--leave);
        }
        
        .action-btn {
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.3rem;
        }
        
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
        }
        
        .filter-group label {
            margin-left: 0.5rem;
            margin-bottom: 0;
        }
        
        .filter-group select {
            width: auto;
            padding: 0.5rem;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .records-container, .records-container * {
                visibility: visible;
            }
            .records-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .btn, .form-container, .filter-container {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            th, td {
                padding: 0.8rem;
            }
            
            .filter-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="وێنە/l-h.png" alt="Logo" class="header-logo">
        <div class="header-text">
            <h1>لیوای ١٨ فەوجی ٣</h1>
            <p>سیستەمی بەڕێوەبردنی غیاب و مۆڵەت</p>
        </div>
        <img src="وێنە/l-w.png" alt="Logo" class="header-logo">
    </div>
    
    <!-- Profile Section Overlay -->
    <div id="profileOverlay" class="profile-overlay" style="display: none;">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-pic-container">
                    <img id="profileImage" src="profile-placeholder.png" alt="Profile Picture" class="profile-pic">
                    <label class="profile-upload" for="profileUpload">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="profileUpload" accept="image/*">
                    </label>
                </div>
                <div class="profile-info">
                    <h2 class="profile-name" id="profileName">ناوی بەکارهێنەر</h2>
                    <p class="profile-role">بەڕێوەبەری سیستەم</p>
                </div>
                <button onclick="hideProfileSection()" class="close-btn">&times;</button>
            </div>
            
            <div class="profile-sections">
                <div class="profile-tab active" onclick="showProfileTab('profile')">
                    <i class="fas fa-user"></i> پرۆفایل
                </div>
                <div class="profile-tab" onclick="showProfileTab('password')">
                    <i class="fas fa-key"></i> گۆڕینی وشەی نهێنی
                </div>
                <div class="profile-tab" onclick="showProfileTab('backup')">
                    <i class="fas fa-database"></i> پشتیوانی
                </div>
            </div>
            
            <!-- Profile Tab Content -->
            <div id="profileTab" class="profile-content active">
                <h3>زانیارییەکانی پرۆفایل</h3>
                <div class="form-group">
                    <label for="fullName">ناوی تەواو</label>
                    <input type="text" id="fullName" value="ناوی تەواو">
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="saveProfile()">پاشەکەوت کردنی گۆڕانکارییەکان</button>
                </div>
            </div>
            
            <!-- Password Tab Content -->
            <div id="passwordTab" class="profile-content">
                <h3>گۆڕینی وشەی نهێنی</h3>
                <div class="form-group">
                    <label for="currentPassword">وشەی نهێنی ئێستا</label>
                    <input type="password" id="currentPassword" placeholder="وشەی نهێنی ئێستا بنووسە">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="newPassword">وشەی نهێنی نوێ</label>
                        <input type="password" id="newPassword" placeholder="وشەی نهێنی نوێ">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">دووبارەکردنەوەی وشەی نهێنی نوێ</label>
                        <input type="password" id="confirmPassword" placeholder="دووبارەکردنەوەی وشەی نهێنی نوێ">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="changePassword()">گۆڕینی وشەی نهێنی</button>
                </div>
                <p id="passwordMessage" class="error-message"></p>
            </div>
            
            <!-- Backup Tab Content -->
            <div id="backupTab" class="profile-content">
                <h3>پشتیوانی و گەڕاندنەوەی زانیارییەکان</h3>
                <p>لێرە دەتوانیت زانیارییەکانی سیستەم هەڵبگریت یان گەڕانەوەی لێبکەیتەوە.</p>
                
                <div class="backup-options">
                    <div class="backup-card" onclick="exportData()">
                        <div class="backup-icon">
                            <i class="fas fa-file-export"></i>
                        </div>
                        <h4>هەڵگرتنی زانیارییەکان</h4>
                        <p>هەموو زانیارییەکان وەک فایلێکی JSON هەڵبگرە</p>
                    </div>
                    
                    <div class="backup-card" onclick="document.getElementById('restoreFile').click()">
                        <div class="backup-icon">
                            <i class="fas fa-file-import"></i>
                        </div>
                        <h4>گەڕاندنەوەی زانیارییەکان</h4>
                        <p>زانیارییە پێشووەکان لە فایلێکەوە بخەرە ناو سیستەمەوە</p>
                        <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="importData(event)">
                    </div>
                </div>
                <p id="backupMessage" class="success-message"></p>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="checkProfilePassword()" class="btn" style="width: auto; padding: 0.5rem 1rem; background: var(--primary);">
                    <i class="fas fa-user"></i> پرۆفایل
                </button>
                <div style="position: relative; display: inline-block;">
                    <button onclick="promptForPassword()" class="btn" style="width: auto; padding: 0.5rem 1rem; background-color: var(--accent);">
                        <i class="fas fa-users"></i> بەڕێوەبردنی سەربازەکان
                        <span id="totalSoldiersCounter" style="position: absolute; top: -8px; right: -8px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">0</span>
                    </button>
                </div>
            </div>
            <button id="themeToggle" class="icon-btn" title="">
                <i class="fas fa-adjust theme-icon"></i>
                <span class="theme-text">شێوازی ڕووناکی</span>
            </button>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="showTab('absenceFormContainer')">تۆماری غیاب</div>
            <div class="tab" onclick="showTab('leaveFormContainer')">تۆماری مۆڵەت</div>
            <div class="tab" onclick="showTab('recordsContainer')">تۆماری غیاب و مۆڵەت</div>
            <div class="tab" onclick="showTab('weeklyReportContainer')">ڕاپۆرتی هەفتانە</div>
        </div>
        
        <!-- Absence Form -->
        <div id="absenceFormContainer" class="form-container">
            <h2 style="color: var(--primary); margin-top: 0;">تۆمارکردنی غیابی نوێ</h2>
            <form id="absenceForm">
                <div class="form-group">
                    <label for="soldierName">ناوی سەرباز</label>
                    <input type="text" id="soldierName" required oninput="fillSoldierData('absence')" placeholder="ناوی سەرباز" autocomplete="off">
                    <!-- Custom dropdown will be inserted here by JavaScript -->
                </div>
                
                <div class="form-group">
                    <label for="rank">پلە</label>
                    <select id="rank" required>
                        <option value="">هەڵبژێرە</option>
                        <option value="پ.م">پ.م</option>
                        <option value="جندي اول">جندي اول</option>
                        <option value="نائب عریف">نائب عریف</option>
                        <option value="عریف">عریف</option>
                        <option value="رئیس عرفاء">رئیس عرفاء</option>
                        <option value="ن.ض د٨">ن.ض د٨</option>
                        <option value="ن.ض د٧">ن.ض د٧</option>
                        <option value="ن.ض د٦">ن.ض د٦</option>
                        <option value="ن.ض د٥">ن.ض د٥</option>
                        <option value="ن.ض د٤">ن.ض د٤</option>
                        <option value="ن.ض د٣">ن.ض د٣</option>
                        <option value="ن.ض د٢">ن.ض د٢</option>
                        <option value="ن.ض د١">ن.ض د١</option>
                        <option value="ن.ض د/ممتاز">ن.ض د/ممتاز</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="unit">شوێن/یەکە</label>
                    <select id="unit" required>
                        <option value="">هەڵبژێرە</option>
                        <option value="بارەگا">بارەگا</option>
                        <option value="مشاة الی">مشاة الی</option>
                        <option value="اسناد">اسناد</option>
                        <option value="سریەی١ ف١">سریەی١ ف١</option>
                        <option value="سریەی١ ف٢">سریەی١ ف٢</option>
                        <option value="سریەی١ ف٣">سریەی١ ف٣</option>
                        <option value="سریەی٢ ف١">سریەی٢ ف١</option>
                        <option value="سریەی٢ ف٢">سریەی٢ ف٢</option>
                        <option value="سریەی٢ ف٣">سریەی٢ ف٣</option>
                        <option value="سریەی٣ ف١">سریەی٣ ف١</option>
                        <option value="سریەی٣ ف٢">سریەی٣ ف٢</option>
                        <option value="سریەی٣ ف٣">سریەی٣ ف٣</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="absenceDate">بەرواری غیاب</label>
                    <input type="date" id="absenceDate" required>
                </div>
                
                <div class="form-group">
                    <label for="absenceReturnDate">بەرواری گەڕانەوەی غایب</label>
                    <input type="date" id="absenceReturnDate">
                </div>

                <div class="form-group">
                    <label for="notes">تێبینی</label>
                    <textarea id="notes" rows="3" placeholder="تێبینییەکان..."></textarea>
                </div>
                
                <button type="button" onclick="saveRecord('absence')" class="btn">
                    تۆمارکردنی غیاب
                </button>
            </form>
        </div>
        
        <!-- Leave Form -->
        <div id="leaveFormContainer" class="form-container" style="display: none;">
            <h2 style="color: var(--leave); margin-top: 0;">تۆمارکردنی مۆڵەتی نوێ</h2>
            <form id="leaveForm">
                <div class="form-group">
                    <label for="leaveSoldierName">ناوی سەرباز</label>
                    <input type="text" id="leaveSoldierName" required oninput="fillSoldierData('leave')" placeholder="ناوی سەرباز" autocomplete="off">
                    <!-- Custom dropdown will be inserted here by JavaScript -->
                </div>
                
                <div class="form-group">
                    <label for="leaveRank">پلە</label>
                    <select id="leaveRank" required>
                        <option value="">هەڵبژێرە</option>
                        <option value="پ.م">پ.م</option>
                        <option value="جندي اول">جندي اول</option>
                        <option value="نائب عریف">نائب عریف</option>
                        <option value="عریف">عریف</option>
                        <option value="رئیس عرفاء">رئیس عرفاء</option>
                        <option value="ن.ض د٨">ن.ض د٨</option>
                        <option value="ن.ض د٧">ن.ض د٧</option>
                        <option value="ن.ض د٦">ن.ض د٦</option>
                        <option value="ن.ض د٥">ن.ض د٥</option>
                        <option value="ن.ض د٤">ن.ض د٤</option>
                        <option value="ن.ض د٣">ن.ض د٣</option>
                        <option value="ن.ض د٢">ن.ض د٢</option>
                        <option value="ن.ض د١">ن.ض د١</option>
                        <option value="ن.ض د/ممتاز">ن.ض د/ممتاز</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="leaveUnit">شوێن/یەکە</label>
                    <select id="leaveUnit" required>
                        <option value="">هەڵبژێرە</option>
                        <option value="بارەگا">بارەگا</option>
                        <option value="مشاة الی">مشاة الی</option>
                        <option value="اسناد">اسناد</option>
                        <option value="سریەی١ ف١">سریەی١ ف١</option>
                        <option value="سریەی١ ف٢">سریەی١ ف٢</option>
                        <option value="سریەی١ ف٣">سریەی١ ف٣</option>
                        <option value="سریەی٢ ف١">سریەی٢ ف١</option>
                        <option value="سریەی٢ ف٢">سریەی٢ ف٢</option>
                        <option value="سریەی٢ ف٣">سریەی٢ ف٣</option>
                        <option value="سریەی٣ ف١">سریەی٣ ف١</option>
                        <option value="سریەی٣ ف٢">سریەی٣ ف٢</option>
                        <option value="سریەی٣ ف٣">سریەی٣ ف٣</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="leaveStartDate">بەرواری دەستپێک</label>
                    <input type="date" id="leaveStartDate" required>
                </div>
                
                <div class="form-group">
                    <label for="leaveEndDate">بەرواری کۆتایی</label>
                    <input type="date" id="leaveEndDate" required>
                </div>
                
                <div class="form-group">
                    <label for="leaveType">جۆری مۆڵەت</label>
                    <select id="leaveType" required>
                        <option value="">هەڵبژێرە</option>
                        <option value="مۆڵەتی ئاسایی">مۆڵەتی ئاسایی</option>
                        <option value="مۆڵەتی نەخۆشی">مۆڵەتی نەخۆشی</option>
                        <option value="مۆڵەتی تایبەت">مۆڵەتی تایبەت</option>
                        <option value="مۆڵەتی فەرمی">مۆڵەتی فەرمی</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="leaveNotes">تێبینی</label>
                    <textarea id="leaveNotes" rows="3" placeholder="تێبینییەکان..."></textarea>
                </div>
                
                <button type="button" onclick="saveRecord('leave')" class="btn btn-leave">
                    تۆمارکردنی مۆڵەت
                </button>
            </form>
        </div>
        
        <!-- Records Section -->
        <div id="recordsContainer" class="form-container" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0; color: var(--primary);">تۆماری غیاب و مۆڵەت</h2>
                <div>
                    <button onclick="window.print()" class="btn btn-print" style="width: auto; padding: 0.5rem 1rem;">
                        چاپکردن
                    </button>
                    <button onclick="exportToExcel()" class="btn btn-leave" style="width: auto; padding: 0.5rem 1rem; margin-left: 0.5rem;">
                        هەناردە بۆ Excel
                    </button>
                </div>
            </div>
            
            <div class="filter-container">
                <div class="filter-group">
                    <label for="filterType">جۆر:</label>
                    <select id="filterType" onchange="filterRecords()">
                        <option value="all">هەموو</option>
                        <option value="absence">غیاب</option>
                        <option value="leave">مۆڵەت</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterYear">ساڵ:</label>
                    <select id="filterYear" onchange="filterRecords()">
                        <option value="all">هەموو ساڵەکان</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterMonth">مانگ:</label>
                    <select id="filterMonth" onchange="filterRecords()">
                        <option value="all">هەموو مانگەکان</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterUnit">یەکە:</label>
                    <select id="filterUnit" onchange="filterRecords()">
                        <option value="all">هەموو یەکەکان</option>
                        <option value="بارەگا">بارەگا</option>
                        <option value="مشاة الی">مشاة الی</option>
                        <option value="اسناد">اسناد</option>
                        <option value="سریەی١ ف١">سریەی١ ف١</option>
                        <option value="سریەی١ ف٢">سریەی١ ف٢</option>
                        <option value="سریەی١ ف٣">سریەی١ ف٣</option>
                        <option value="سریەی٢ ف١">سریەی٢ ف١</option>
                        <option value="سریەی٢ ف٢">سریەی٢ ف٢</option>
                        <option value="سریەی٢ ف٣">سریەی٢ ف٣</option>
                        <option value="سریەی٣ ف١">سریەی٣ ف١</option>
                        <option value="سریەی٣ ف٢">سریەی٣ ف٢</option>
                        <option value="سریەی٣ ف٣">سریەی٣ ف٣</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterName">ناو:</label>
                    <input type="text" id="filterName" placeholder="ناوی سەرباز" oninput="filterRecords()">
                </div>
                
                <button onclick="clearFilters()" class="btn" style="width: auto; padding: 0.5rem 1rem;">
                    پاککردنەوەی فلتەرەکان
                </button>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th>ناو</th>
                            <th>پلە</th>
                            <th>یەکە</th>
                            <th>ژمارەی غیابەکان</th>
                            <th>ژمارەی مۆڵەتەکان</th>
                            <th>کۆی غیاب و مۆڵەت</th>
                            <th>ژمارەی ڕۆژە بەردەوامەکان</th>
                            <th>تێبینی</th>
                            <th>کردارەکان</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTable">
                        <!-- تۆمارەکان بە شێوەیەکی خۆکارانە زیاد دەکرێن -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Weekly Report Container -->
        <div id="weeklyReportContainer" class="form-container" style="display: none; background: #f8fafc; border-radius: 10px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
            <!-- Header Section -->
            <div class="report-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1.25rem; border-bottom: 1px solid #e2e8f0;">
                <div>
                    <h2 style="margin: 0; color: #1e3a8a; font-size: 1.75rem; font-weight: 700;">ڕاپۆرتی هەفتانەی غیاب و مۆڵەت</h2>
                    <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 1rem;">
                        <i class="far fa-calendar-alt" style="margin-left: 0.5rem;"></i>
                        هەفتەی <span id="selectedWeek">-</span>ی مانگی <span id="selectedWeekMonth">-</span> - ساڵی <span id="selectedWeekYear">-</span>
                    </p>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <button onclick="printWeeklyReport()" class="btn" style="background: #4f46e5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-print"></i>
                        چاپکردن
                    </button>
                    <button onclick="resetWeeklyReportFilters()" class="btn" style="background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-redo"></i>
                        ڕیست کردنی هەموو فلتەرەکان
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-container" style="margin-bottom: 2rem; background: #ffffff; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; color: #1e293b; font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-filter" style="color: #4f46e5; background: #eef2ff; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center;"></i>
                        فلتەرەکانی ڕاپۆرت
                    </h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Year Filter -->
                    <div class="filter-group">
                        <label for="weeklyReportYear" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500; font-size: 0.95rem; font-family: 'Tajawal', sans-serif;">
                            <i class="far fa-calendar-alt" style="margin-left: 0.5rem;"></i>
                            هەڵبژاردنی ساڵ
                        </label>
                        <div style="position: relative;">
                            <select id="weeklyReportYear" class="form-control" onchange="generateWeeklyReport()" style="width: 100%; padding: 0.6rem 1rem; padding-left: 2.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; font-family: 'Tajawal', sans-serif; font-size: 0.95rem; appearance: none; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#a5b4fc'; this.style.boxShadow='0 0 0 3px rgba(165, 180, 252, 0.2)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                                <option value="2023">٢٠٢٣</option>
                                <option value="2024" selected>٢٠٢٤</option>
                                <option value="2025">٢٠٢٥</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; font-size: 0.8rem;"></i>
                        </div>
                    </div>
                    
                    <!-- Month Filter -->
                    <div class="filter-group">
                        <label for="weeklyReportMonth" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500; font-size: 0.95rem; font-family: 'Tajawal', sans-serif;">
                            <i class="far fa-calendar" style="margin-left: 0.5rem;"></i>
                            هەڵبژاردنی مانگ
                        </label>
                        <div style="position: relative;">
                            <select id="weeklyReportMonth" class="form-control" onchange="updateWeeksDropdown(); generateWeeklyReport()" style="width: 100%; padding: 0.6rem 1rem; padding-left: 2.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; font-family: 'Tajawal', sans-serif; font-size: 0.95rem; appearance: none; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#a5b4fc'; this.style.boxShadow='0 0 0 3px rgba(165, 180, 252, 0.2)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                                <option value="1">کانوونی دووەم</option>
                                <option value="2">شوبات</option>
                                <option value="3">ئازار</option>
                                <option value="4">نیسان</option>
                                <option value="5">ئایار</option>
                                <option value="6">حوزەیران</option>
                                <option value="7">تەمموز</option>
                                <option value="8">ئاب</option>
                                <option value="9">ئەیلوول</option>
                                <option value="10">تشرینی یەکەم</option>
                                <option value="11">تشرینی دووەم</option>
                                <option value="12">کانوونی یەکەم</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; font-size: 0.8rem;"></i>
                        </div>
                    </div>
                    
                    <!-- Start Date Filter -->
                    <div class="filter-group">
                        <label for="weeklyStartDate" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500; font-size: 0.95rem; font-family: 'Tajawal', sans-serif;">
                            <i class="far fa-calendar" style="margin-left: 0.5rem;"></i>
                            بەرواری دەستپێک
                        </label>
                        <div style="position: relative;">
                            <input type="date" id="weeklyStartDate" class="form-control" onchange="updateWeeklyDateRange(true)" style="width: 100%; padding: 0.6rem 1rem; padding-left: 2.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; font-family: 'Tajawal', sans-serif; font-size: 0.95rem;" onfocus="this.style.borderColor='#a5b4fc'; this.style.boxShadow='0 0 0 3px rgba(165, 180, 252, 0.2)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                            <i class="far fa-calendar" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; font-size: 0.9rem;"></i>
                        </div>
                    </div>

                    <!-- End Date Filter -->
                    <div class="filter-group">
                        <label for="weeklyEndDate" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500; font-size: 0.95rem; font-family: 'Tajawal', sans-serif;">
                            <i class="far fa-calendar" style="margin-left: 0.5rem;"></i>
                            بەرواری کۆتایی
                        </label>
                        <div style="position: relative;">
                            <input type="date" id="weeklyEndDate" class="form-control" onchange="updateWeeklyDateRange(false)" style="width: 100%; padding: 0.6rem 1rem; padding-left: 2.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; font-family: 'Tajawal', sans-serif; font-size: 0.95rem;" onfocus="this.style.borderColor='#a5b4fc'; this.style.boxShadow='0 0 0 3px rgba(165, 180, 252, 0.2)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                            <i class="far fa-calendar" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; font-size: 0.9rem;"></i>
                        </div>
                    </div>
                    
                    <!-- Unit Filter -->
                    <div class="filter-group">
                        <label for="weeklyReportUnit" style="display: block; margin-bottom: 0.5rem; color: #475569; font-weight: 500; font-size: 0.95rem; font-family: 'Tajawal', sans-serif;">
                            <i class="fas fa-building" style="margin-left: 0.5rem;"></i>
                            هەڵبژاردنی یەکە
                        </label>
                        <div style="position: relative;">
                            <select id="weeklyReportUnit" class="form-control" onchange="generateWeeklyReport()" style="width: 100%; padding: 0.6rem 1rem; padding-left: 2.5rem; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8fafc; font-family: 'Tajawal', sans-serif; font-size: 0.95rem; appearance: none; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#a5b4fc'; this.style.boxShadow='0 0 0 3px rgba(165, 180, 252, 0.2)';" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';">
                                <option value="">هەموو یەکەکان</option>
                                <option value="بارەگا">بارەگا</option>
                                <option value="مشاة الی">مشاة الی</option>
                                <option value="اسناد">اسناد</option>
                                <option value="سریەی١ ف١">سریەی١ ف١</option>
                                <option value="سریەی١ ف٢">سریەی١ ف٢</option>
                                <option value="سریەی١ ف٣">سریەی١ ف٣</option>
                                <option value="سریەی٢ ف١">سریەی٢ ف١</option>
                                <option value="سریەی٢ ف٢">سریەی٢ ف٢</option>
                                <option value="سریەی٢ ف٣">سریەی٢ ف٣</option>
                                <option value="سریەی٣ ف١">سریەی٣ ف١</option>
                                <option value="سریەی٣ ف٢">سریەی٣ ف٢</option>
                                <option value="سریەی٣ ف٣">سریەی٣ ف٣</option>
                            </select>
                            <i class="fas fa-chevron-down" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events: none; font-size: 0.8rem;"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Active Filters -->
                <div id="weeklyActiveFiltersContainer" style="margin-top: 1.5rem; display: none;">
                    <h4 style="margin: 0 0 0.75rem 0; color: #475569; font-size: 0.95rem; font-weight: 500;">
                        <i class="fas fa-filter" style="margin-left: 0.5rem; color: #4f46e5;"></i>
                        فلتەرە هەڵبژێردراوەکان:
                    </h4>
                    <div id="weeklyActiveFilters" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <!-- Active filters will be added here -->
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem; margin-bottom: 2rem;">
                <!-- Total Soldiers Card -->
                <div class="summary-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 10px; padding: 1.5rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.9);">کۆی گشتی سەربازەکان</h3>
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-users" style="font-size: 1.25rem; color: white;"></i>
                        </div>
                    </div>
                    <div id="weeklyTotalSoldiers" style="font-size: 2rem; font-weight: 700;">٠</div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.9; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-left: 0.25rem;"></i>
                        <span>کۆی گشتی سەربازە چالاکەکان</span>
                    </div>
                </div>
                
                <!-- Total Absences Card -->
                <div class="summary-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 10px; padding: 1.5rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.9);">کۆی غیابەکان</h3>
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-times" style="font-size: 1.25rem; color: white;"></i>
                        </div>
                    </div>
                    <div id="weeklyTotalAbsences" style="font-size: 2rem; font-weight: 700;">٠</div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.9; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-left: 0.25rem;"></i>
                        <span>کۆی ژمارەی غیابەکان</span>
                    </div>
                </div>
                
                <!-- Total Leaves Card -->
                <div class="summary-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; padding: 1.5rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.9);">کۆی مۆڵەتەکان</h3>
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-umbrella-beach" style="font-size: 1.25rem; color: white;"></i>
                        </div>
                    </div>
                    <div id="weeklyTotalLeaves" style="font-size: 2rem; font-weight: 700;">٠</div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.9; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-left: 0.25rem;"></i>
                        <span>کۆی ژمارەی مۆڵەتەکان</span>
                    </div>
                </div>
                
                <!-- Absence Rate Card -->
                <div class="summary-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; padding: 1.5rem; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1rem; font-weight: 500; color: rgba(255, 255, 255, 0.9);">ڕێژەی غیاب</h3>
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-chart-pie" style="font-size: 1.25rem; color: white;"></i>
                        </div>
                    </div>
                    <div id="weeklyAbsenceRate" style="font-size: 2rem; font-weight: 700;">٠%</div>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; opacity: 0.9; display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-left: 0.25rem;"></i>
                        <span>ڕێژەی غیاب لەسەد</span>
                    </div>
                </div>
            </div>

            <!-- Detailed Report Table -->
            <div style="overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">ناو</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">پلە</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">یەکە</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">ژمارەی غیاب</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">ژمارەی مۆڵەت</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">کۆی ڕۆژەکان</th>
                            <th style="padding: 1rem; text-align: right; border-bottom: 2px solid #eee;">تێبینی</th>
                        </tr>
                    </thead>
                    <tbody id="weeklyReportTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #64748b;">
                                <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                                تکایە ساڵ و مانگ و هەفتەی مەبەست هەڵبژێرە بۆ بینینی ڕاپۆرت
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Report Summary -->
            <div style="margin-top: 2rem; background: #f8f9fa; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                    <h3 style="margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-chart-bar" style="color: var(--primary);"></i>
                        کورتەی گشتی ڕاپۆرت
                    </h3>
                    <div id="weeklyReportSummary" style="line-height: 1.8; color: #334155;">
                        <p style="margin: 0.5rem 0;">تکایە ساڵ و مانگ و هەفتەی مەبەست هەڵبژێرە بۆ بینینی ڕاپۆرتی هەفتانە.</p>
                    </div>
                </div>
                
                <!-- Detailed Statistics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; padding: 1.5rem;">
                    <!-- Total Absences -->
                    <div style="background: white; border-radius: 8px; padding: 1.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="margin: 0; font-size: 0.95rem; color: #64748b;">کۆی گشتی غیابەکان</h4>
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: #fef2f2; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user-times" style="color: #ef4444; font-size: 1rem;"></i>
                            </div>
                        </div>
                        <div id="weeklyTotalAbsencesCard" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">-</div>
                        <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #64748b;">
                            <span id="weeklyAbsencePercentage">-</span> لە سەد لە کۆی سەربازەکان
                        </div>
                    </div>
                    
                    <!-- Total Leaves -->
                    <div style="background: white; border-radius: 8px; padding: 1.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="margin: 0; font-size: 0.95rem; color: #64748b;">کۆی گشتی مۆڵەتەکان</h4>
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: #ecfdf5; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-umbrella-beach" style="color: #10b981; font-size: 1rem;"></i>
                            </div>
                        </div>
                        <div id="weeklyTotalLeavesCard" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">-</div>
                        <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #64748b;">
                            <span id="weeklyLeavePercentage">-</span> لە سەد لە کۆی سەربازەکان
                        </div>
                    </div>
                    
                    <!-- Leave Ratio -->
                    <div style="background: white; border-radius: 8px; padding: 1.25rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="margin: 0; font-size: 0.95rem; color: #64748b;">ڕێژەی مۆڵەت</h4>
                            <div style="width: 36px; height: 36px; border-radius: 8px; background: #f0fdfa; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-percentage" style="color: #0d9488; font-size: 1rem;"></i>
                            </div>
                        </div>
                        <div id="weeklyLeaveRatio" style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">-</div>
                        <div style="margin-top: 0.25rem; font-size: 0.85rem; color: #64748b;">
                            <span id="weeklyLeaveRatioPercentage">-</span> لە سەد لە کۆی سەربازەکان
                        </div>
                    </div>
                </div>
                
                <!-- Detailed List -->
                <div style="padding: 0 1.5rem 1.5rem 1.5rem;">
                    <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: #475569; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-list-ul" style="color: #6b7280;"></i>
                        لیستی وردی غیاب و مۆڵەتەکان
                    </h4>
                    <div id="weeklyAbsenceLeaveItems" style="background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb;">
                        <div style="padding: 1rem; text-align: center; color: #9ca3af; font-size: 0.9rem;">
                            هیچ زانیارییەکی غیاب یان مۆڵەت بەردەست نییە
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            body * {
                visibility: hidden;
            }
            #weeklyReportContainer, #weeklyReportContainer * {
                visibility: visible;
            }
            #weeklyReportContainer {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .summary-cards {
                display: flex !important;
                flex-wrap: wrap;
                gap: 10px !important;
                margin-bottom: 15px !important;
            }
            .summary-card {
                flex: 1;
                min-width: 200px;
                padding: 10px !important;
                page-break-inside: avoid;
            }
        }
    </style>

    <script>
        // Dark mode functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = themeToggle.querySelector('i');
            
            // Check for saved user preference, if any
            const currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i> شێوازی ڕووناک';
            }
            
            // Toggle theme on button click
            themeToggle.addEventListener('click', function() {
                let theme = 'light';
                if (document.documentElement.getAttribute('data-theme') !== 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    theme = 'dark';
                    themeIcon.classList.replace('fa-moon', 'fa-sun');
                    this.innerHTML = '<i class="fas fa-sun"></i> شێوازی ڕووناک';
                } else {
                    document.documentElement.removeAttribute('data-theme');
                    themeIcon.classList.replace('fa-sun', 'fa-moon');
                    this.innerHTML = '<i class="fas fa-moon"></i> شێوازی تاریک';
                }
                localStorage.setItem('theme', theme);
            });
        });
        
        // Show/hide tabs
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.form-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            if (tabName === 'absenceFormContainer') {
                document.getElementById('absenceFormContainer').style.display = 'block';
                document.querySelector('.tab:nth-child(1)').classList.add('active');
            } else if (tabName === 'leaveFormContainer') {
                document.getElementById('leaveFormContainer').style.display = 'block';
                document.querySelector('.tab:nth-child(2)').classList.add('active');
            } else if (tabName === 'recordsContainer') {
                document.getElementById('recordsContainer').style.display = 'block';
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                filterRecords();
            } else if (tabName === 'weeklyReportContainer') {
                document.getElementById('weeklyReportContainer').style.display = 'block';
                document.querySelector('.tab:nth-child(4)').classList.add('active');
                generateWeeklyReport();
            }
        }
        
        async function saveToGoogleSheets(data) {
            const SCRIPT_URL = 'https://script.google.com/macros/s/1ATA3PdQPhhaPikTFtJgDWZ3vlsV0zMYkCV8KXnpwsnu73yKtgUjOBiBI/exec';
            
            try {
                data.timestamp = new Date().toISOString();
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                return { status: 'success', message: 'زانیارییەکان نێردران' };
            } catch (error) {
                console.error('هەڵە لە ناردنی زانیارییەکان:', error);
                throw error;
            }
        }
        
        // Save records
        async function saveRecord(type) {
            try {
                if(type === 'absence') {
                    const soldierName = document.getElementById('soldierName').value;
                    const soldiers = JSON.parse(localStorage.getItem('soldiers')) || [];
                    const soldierExists = soldiers.some(s => s.name === soldierName);
                    
                    if (!soldierExists) {
                        alert("تکایە ناوی سەربازێکی تۆمارکراو هەڵبژێرە!");
                        return;
                    }
                    
                    const data = {
                        type: 'absence',
                        name: soldierName,
                        rank: document.getElementById('rank').value,
                        unit: document.getElementById('unit').value,
                        date: document.getElementById('absenceDate').value,
                        returnDate: document.getElementById('absenceReturnDate').value || '',
                        notes: document.getElementById('notes').value || ''
                    };
                    
                    if (!data.name || !data.rank || !data.unit || !data.date) {
                        alert("تکایە هەموو خانە پڕەکان پڕ بکەرەوە!");
                        return;
                    }
                    
                    // Save to Google Sheets
                    await saveToGoogleSheets(data);
                    
                    // Update UI
                    const table = document.getElementById('recordsTable');
                    const row = table.insertRow(0);
                    row.className = 'absence';
                    row.setAttribute('data-date', data.date);
                    row.setAttribute('data-unit', data.unit);
                    row.innerHTML = `
                        <td>${data.name}</td>
                        <td>${data.rank}</td>
                        <td>${data.unit}</td>
                        <td><span class="badge badge-absence">غیاب</span></td>
                        <td>${data.date}${data.returnDate ? ' - ' + data.returnDate : ''}</td>
                        <td>${data.notes || '-'}</td>
                        <td>
                            <button onclick="editRecord(this)" class="action-btn" style="background-color: var(--accent);">گۆڕانکاری</button>
                            <button onclick="deleteRecord(this)" class="action-btn" style="background-color: var(--delete);">سڕینەوە</button>
                        </td>
                    `;
                    
                    document.getElementById('absenceForm').reset();
                    saveRecordsToStorage();
                    alert("تۆمارەکەت بە سەرکەوتوویی تۆمارکرا!");
                } else {
                    const soldierName = document.getElementById('leaveSoldierName').value;
                    const soldiers = JSON.parse(localStorage.getItem('soldiers')) || [];
                    const soldierExists = soldiers.some(s => s.name === soldierName);
                    
                    if (!soldierExists) {
                        alert("تکایە ناوی سەربازێکی تۆمارکراو هەڵبژێرە!");
                        return;
                    }
                    
                    const data = {
                        type: 'leave',
                        name: soldierName,
                        rank: document.getElementById('leaveRank').value,
                        unit: document.getElementById('leaveUnit').value,
                        startDate: document.getElementById('leaveStartDate').value,
                        endDate: document.getElementById('leaveEndDate').value,
                        leaveType: document.getElementById('leaveType').value,
                        notes: document.getElementById('leaveNotes').value || ''
                    };
                    
                    if (!data.name || !data.rank || !data.unit || !data.startDate || !data.endDate || !data.leaveType) {
                        alert("تکایە هەموو خانە پڕەکان پڕ بکەرەوە!");
                        return;
                    }
                    
                    // Save to Google Sheets
                    await saveToGoogleSheets(data);
                    
                    // Update UI
                    const table = document.getElementById('recordsTable');
                    const row = table.insertRow(0);
                    row.className = 'leave';
                    row.setAttribute('data-date', data.startDate);
                    row.setAttribute('data-unit', data.unit);
                    row.innerHTML = `
                        <td>${data.name}</td>
                        <td>${data.rank}</td>
                        <td>${data.unit}</td>
                        <td><span class="badge badge-leave">مۆڵەت</span></td>
                        <td>${data.startDate} - ${data.endDate}</td>
                        <td>${data.leaveType}${data.notes ? '<br>' + data.notes : ''}</td>
                        <td>
                            <button onclick="editRecord(this)" class="action-btn" style="background-color: var(--accent);">گۆڕانکاری</button>
                            <button onclick="deleteRecord(this)" class="action-btn" style="background-color: var(--delete);">سڕینەوە</button>
                        </td>
                    `;
                    
                    document.getElementById('leaveForm').reset();
                    saveRecordsToStorage();
                    alert("تۆمارەکەت بە سەرکەوتوویی تۆمارکرا!");
                }
            } catch (error) {
                console.error('Error saving record:', error);
                alert("هەڵەیەک ڕوویدا لە کاتی پەیوەندیکردن بە سێرڤەرەوە");
            }
        }
        
        // Save records to localStorage
        function saveRecordsToStorage() {
            const table = document.getElementById('recordsTable');
            const records = [];
            
            // هەموو ڕیزەکان کۆبکەرەوە
            table.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                const isLeave = row.classList.contains('leave');
                
                records.push({
                    type: isLeave ? 'leave' : 'absence',
                    name: cells[0].textContent,
                    rank: cells[1].textContent,
                    unit: cells[2].textContent,
                    date: cells[4].textContent,
                    notes: cells[5].textContent,
                    rowClass: row.className,
                    dataDate: row.getAttribute('data-date'),
                    dataUnit: row.getAttribute('data-unit')
                });
            });
            
            // هەڵگرتنی تۆمارەکان لە localStorage
            localStorage.setItem('militaryRecords', JSON.stringify(records));
        }
        
        // Load records from localStorage
        function loadRecordsFromStorage() {
            const savedRecords = localStorage.getItem('militaryRecords');
            if (!savedRecords) return;
            
            const records = JSON.parse(savedRecords);
            const table = document.getElementById('recordsTable');
            table.innerHTML = ''; // Clear previous options
            
            records.forEach(record => {
                const row = table.insertRow(0);
                row.className = record.rowClass;
                row.setAttribute('data-date', record.dataDate);
                row.setAttribute('data-unit', record.dataUnit);
                
                if (record.type === 'absence') {
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.rank}</td>
                        <td>${record.unit}</td>
                        <td><span class="badge badge-absence">غیاب</span></td>
                        <td>${record.date}</td>
                        <td>${record.notes}</td>
                        <td>
                            <button onclick="editRecord(this)" class="action-btn" style="background-color: var(--accent);">گۆڕانکاری</button>
                            <button onclick="deleteRecord(this)" class="action-btn" style="background-color: var(--delete);">سڕینەوە</button>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.rank}</td>
                        <td>${record.unit}</td>
                        <td><span class="badge badge-leave">مۆڵەت</span></td>
                        <td>${record.date}</td>
                        <td>${record.notes}</td>
                        <td>
                            <button onclick="editRecord(this)" class="action-btn" style="background-color: var(--accent);">گۆڕانکاری</button>
                            <button onclick="deleteRecord(this)" class="action-btn" style="background-color: var(--delete);">سڕینەوە</button>
                        </td>
                    `;
                }
            });
        }
        
        // Edit record
        function editRecord(button) {
            const row = button.closest('tr');
            const cells = row.querySelectorAll('td');
            const isLeave = row.classList.contains('leave');

            // زانیارییەکانی ڕیزەکە وەربگرە
            const name = cells[0].textContent;
            const rank = cells[1].textContent;
            const unit = cells[2].textContent;
            const notes = cells[5].textContent;

            if (isLeave) {
                // گۆڕانکاری مۆڵەت
                const dates = cells[4].textContent.split(' - ');
                const leaveType = cells[5].textContent.split('\n')[0]; // جۆری مۆڵەت

                document.getElementById('leaveSoldierName').value = name;
                document.getElementById('leaveRank').value = rank;
                document.getElementById('leaveUnit').value = unit;
                document.getElementById('leaveStartDate').value = dates[0];
                document.getElementById('leaveEndDate').value = dates[1];
                document.getElementById('leaveType').value = leaveType;
                document.getElementById('leaveNotes').value = notes.replace(leaveType, '').trim();

                // فۆرمی مۆڵەت پیشان بدە
                showTab('leave');
            } else {
                // گۆڕانکاری غیاب
                const dates = cells[4].textContent.split(' - ');
                const absenceDate = dates[0];
                const returnDate = dates.length > 1 ? dates[1] : '';

                document.getElementById('soldierName').value = name;
                document.getElementById('rank').value = rank;
                document.getElementById('unit').value = unit;
                document.getElementById('absenceDate').value = absenceDate;
                document.getElementById('absenceReturnDate').value = returnDate;
                document.getElementById('notes').value = notes;

                // فۆرمی غیاب پیشان بدە
                showTab('absence');
            }

            // ڕیزەکە بسڕەوە (بۆ ئەوەی دووبارە تۆمار نەکرێتەوە)
            row.remove();
            saveRecordsToStorage();
        }
        
        // Delete record
        function deleteRecord(button) {
            const password = prompt("بۆ سڕینەوە، تکایە پاسوۆرد بنووسە:", "");
            if (password === "1234") {
                if(confirm("دڵنیای لە سڕینەوەی ئەم تۆمارە؟")) {
                    const row = button.closest('tr');
                    row.remove();
                    saveRecordsToStorage(); // تۆمارەکان هەڵبگرە دوای سڕینەوە
                    alert("تۆمارەکە بە سەرکەوتوویی سڕایەوە!");
                }
            } else if (password !== null && password !== "") {
                alert("پاسوۆرد هەڵەیە!");
            }
        }
        
        // Filter records
        function filterRecords() {
            const typeFilter = document.getElementById('filterType').value;
            const yearFilter = document.getElementById('filterYear').value;
            const monthFilter = document.getElementById('filterMonth').value;
            const unitFilter = document.getElementById('filterUnit').value;
            const nameFilter = document.getElementById('filterName').value.toLowerCase();
            
            const rows = document.querySelectorAll('#recordsTable tr');
            
            rows.forEach(row => {
                const rowType = row.classList.contains('absence') ? 'absence' : 'leave';
                const rowDate = row.getAttribute('data-date');
                const rowYear = rowDate ? rowDate.split('-')[0] : '';
                const rowMonth = rowDate ? rowDate.split('-')[1] : '';
                const rowUnit = row.getAttribute('data-unit') || '';
                const rowName = row.querySelector('td:first-child').textContent.toLowerCase();
                
                let showRow = true;
                
                // Apply type filter
                if(typeFilter !== 'all' && rowType !== typeFilter) {
                    showRow = false;
                }
                
                // Apply year filter
                if(yearFilter !== 'all' && rowYear !== yearFilter) {
                    showRow = false;
                }
                
                // Apply month filter
                if(monthFilter !== 'all' && rowMonth !== monthFilter) {
                    showRow = false;
                }
                
                // Apply unit filter
                if(unitFilter !== 'all' && rowUnit !== unitFilter) {
                    showRow = false;
                }
                
                // Apply name filter
                if(nameFilter && !rowName.includes(nameFilter)) {
                    showRow = false;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        // Clear all filters
        function clearFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterYear').value = 'all';
            document.getElementById('filterMonth').value = 'all';
            document.getElementById('filterUnit').value = 'all';
            document.getElementById('filterName').value = '';
            filterRecords();
        }
        
        // Export to Excel
        function exportToExcel() {
            // Create a temporary table with only visible rows
            const originalTable = document.getElementById('mainTable');
            const tempTable = originalTable.cloneNode(true);
            
            // Remove hidden rows
            const rows = tempTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                if(row.style.display === 'none') {
                    row.remove();
                }
            });
            
            // Create HTML content
            const html = tempTable.outerHTML;
            
            // Create download link
            const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'تۆماری_غیاب_و_مۆڵەت.xls';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Track the currently open dropdown
        let currentOpenDropdown = null;
        
        // Function to close any open dropdown
        function closeCurrentDropdown() {
            if (currentOpenDropdown) {
                currentOpenDropdown.style.display = 'none';
                currentOpenDropdown = null;
            }
        }
        
        // Load soldiers and setup search functionality
        function loadSoldiersForSearch() {
            try {
                // Get soldiers from localStorage or initialize empty array
                const soldiers = JSON.parse(localStorage.getItem('soldiers') || '[]');
                
                // Function to create a search result item
                const createSearchResultItem = (soldier, inputElement) => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.style.padding = '8px 12px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.direction = 'rtl';
                    div.style.textAlign = 'right';
                    div.style.fontFamily = "'Tajawal', sans-serif";
                    
                    // Add hover effect
                    div.addEventListener('mouseenter', () => {
                        div.style.backgroundColor = '#f3f4f6';
                    });
                    div.addEventListener('mouseleave', () => {
                        div.style.backgroundColor = '';
                    });
                    
                    // Highlight matching text
                    const name = soldier.name;
                    const rank = soldier.rank || 'بێ پلە';
                    const unit = soldier.unit || 'بێ یەکە';
                    
                    div.innerHTML = `
                        <div style="font-weight: 500; color: #1e40af;">${name}</div>
                        <div style="font-size: 0.85em; color: #4b5563;">
                            ${rank} - ${unit}
                        </div>
                    `;
                    
                    // Handle click on search result
                    div.addEventListener('click', () => {
                        inputElement.value = name;
                        
                        // Update corresponding fields
                        const formType = inputElement.id === 'soldierName' ? 'absence' : 'leave';
                        const rankInput = formType === 'absence' 
                            ? document.getElementById('rank') 
                            : document.getElementById('leaveRank');
                        const unitInput = formType === 'absence'
                            ? document.getElementById('unit')
                            : document.getElementById('leaveUnit');
                            
                        if (rankInput) rankInput.value = soldier.rank || '';
                        if (unitInput) unitInput.value = soldier.unit || '';
                        
                        // Hide dropdown
                        const dropdown = inputElement.nextElementSibling;
                        if (dropdown && dropdown.classList.contains('search-results-dropdown')) {
                            dropdown.style.display = 'none';
                        }
                    });
                    
                    return div;
                };
                
                // Function to show search results
                const showSearchResults = (inputElement, results) => {
                    // Close any currently open dropdown
                    closeCurrentDropdown();
                    
                    if (results.length === 0) return;
                    
                    // Create dropdown container
                    const dropdown = document.createElement('div');
                    dropdown.className = 'search-results-dropdown';
                    dropdown.style.position = 'absolute';
                    dropdown.style.width = inputElement.offsetWidth + 'px';
                    dropdown.style.maxHeight = '300px';
                    dropdown.style.overflowY = 'auto';
                    dropdown.style.background = 'white';
                    dropdown.style.border = '1px solid #d1d5db';
                    dropdown.style.borderRadius = '4px';
                    dropdown.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                    dropdown.style.zIndex = '1000';
                    dropdown.style.marginTop = '4px';
                    
                    // Set this as the current open dropdown
                    currentOpenDropdown = dropdown;
                    
                    // Add results to dropdown
                    results.forEach(soldier => {
                        dropdown.appendChild(createSearchResultItem(soldier, inputElement));
                    });
                    
                    // Insert after input
                    inputElement.parentNode.insertBefore(dropdown, inputElement.nextSibling);
                };
                
                // Function to setup search for an input field
                const setupSearch = (inputElement) => {
                    if (!inputElement) return;
                    
                    // Add wrapper for positioning
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.style.display = 'inline-block';
                    wrapper.style.width = '100%';
                    inputElement.parentNode.insertBefore(wrapper, inputElement);
                    wrapper.appendChild(inputElement);
                    
                    // Show all soldiers when input is focused
                    inputElement.addEventListener('focus', () => {
                        showSearchResults(inputElement, soldiers);
                    });
                    
                    // Add input event listener for filtering
                    inputElement.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.trim().toLowerCase();
                        
                        // If input is empty, show all soldiers
                        if (!searchTerm) {
                            showSearchResults(inputElement, soldiers);
                            return;
                        }
                        
                        // Filter soldiers based on search term
                        const results = soldiers.filter(soldier => 
                            soldier.name.toLowerCase().includes(searchTerm) ||
                            (soldier.rank && soldier.rank.toLowerCase().includes(searchTerm)) ||
                            (soldier.unit && soldier.unit.toLowerCase().includes(searchTerm))
                        );
                        
                        // Show filtered results
                        showSearchResults(inputElement, results);
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        const dropdown = inputElement.nextElementSibling;
                        if (dropdown && dropdown.classList.contains('search-results-dropdown') && 
                            !dropdown.contains(e.target) && e.target !== inputElement) {
                            closeCurrentDropdown();
                        }
                    });
                    
                    // Close dropdown when selecting an item
                    inputElement.addEventListener('select', () => {
                        closeCurrentDropdown();
                    });
                    
                    // Prevent form submission when pressing Enter on dropdown items
                    inputElement.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                        }
                    });
                };
                
                // Setup search for both forms
                setupSearch(document.getElementById('soldierName'));
                setupSearch(document.getElementById('leaveSoldierName'));
                
                // Function to get display text for a soldier
                const getSoldierDisplayText = (soldier) => {
                    return `${soldier.name} (${soldier.rank || 'بێ پلە'} - ${soldier.unit || 'بێ یەکە'})`;
                };
                
                // Function to extract soldier name from display text
                const extractSoldierName = (displayText) => {
                    if (!displayText) return '';
                    // Extract name part before the first parenthesis
                    const match = displayText.match(/^([^(]+)/);
                    return match ? match[0].trim() : displayText.trim();
                };
                
            } catch (error) {
                console.error('هەڵە لە بارکردنی ناوی سەربازەکان بۆ گەڕان:', error);
            }
        }

        // Fill soldier data automatically when a name is selected
        function fillSoldierData(type) {
            try {
                const soldiers = JSON.parse(localStorage.getItem('soldiers') || '[]');
                let nameInput, rankInput, unitInput;

                if (type === 'absence') {
                    nameInput = document.getElementById('soldierName');
                    rankInput = document.getElementById('rank');
                    unitInput = document.getElementById('unit');
                } else { // leave
                    nameInput = document.getElementById('leaveSoldierName');
                    rankInput = document.getElementById('leaveRank');
                    unitInput = document.getElementById('leaveUnit');
                }
                
                if (!nameInput) return;
                
                const inputValue = nameInput.value.trim();
                if (!inputValue) {
                    if (rankInput) rankInput.value = '';
                    if (unitInput) unitInput.value = '';
                    return;
                }
                
                // Try to find the soldier in the soldiers array
                const selectedSoldier = soldiers.find(soldier => {
                    // Check if input matches the display format: "Name (Rank - Unit)"
                    const displayMatch = inputValue === `${soldier.name} (${soldier.rank || 'بێ پلە'} - ${soldier.unit || 'بێ یەکە'})`;
                    // Check if input matches just the name
                    const nameMatch = inputValue === soldier.name;
                    // Check if input contains the name
                    const containsName = inputValue.includes(soldier.name);
                    
                    return displayMatch || nameMatch || containsName;
                });
                
                if (selectedSoldier) {
                    if (rankInput) rankInput.value = selectedSoldier.rank || '';
                    if (unitInput) unitInput.value = selectedSoldier.unit || '';
                } else {
                    // Clear fields if no match is found
                    if (rankInput) rankInput.value = '';
                    if (unitInput) unitInput.value = '';
                }
            } catch (error) {
                console.error('هەڵە لە پڕکردنەوەی زانیارییەکانی سەرباز:', error);
            }
        }

        function promptForPassword() {
            const password = prompt("تکایە پاسوۆرد بنووسە:", "");
            if (password === "1234") {
                sessionStorage.setItem('isLoggedIn', 'true');
                // Open in a new tab
                const newWindow = window.open("soldiers.html", "_blank");
                // Update counter when returning from soldiers management
                if (newWindow) {
                    window.addEventListener('focus', function onFocus() {
                        updateTotalSoldiersCounter();
                        window.removeEventListener('focus', onFocus);
                    }, { once: true });
                }
            } else if (password !== null && password !== "") {
                alert("پاسوۆرد هەڵەیە!");
            }
        }

        // Initialize sample soldiers data if none exists
        function initializeSampleSoldiers() {
            if (!localStorage.getItem('soldiers')) {
                const sampleSoldiers = [
                    { name: 'ئەحمەد محەممەد', rank: 'ن.ض د٤', unit: 'بارەگا' },
                    { name: 'حوسێن عەلی', rank: 'عریف', unit: 'مشاة الی' },
                    { name: 'کەریم عەبدوڵا', rank: 'ن.ض د٣', unit: 'سریەی١ ف١' },
                    { name: 'عەلی حەسەن', rank: 'نائب عریف', unit: 'سریەی٢ ف٢' },
                    { name: 'مەحموود عەباس', rank: 'پ.م', unit: 'اسناد' }
                ];
                localStorage.setItem('soldiers', JSON.stringify(sampleSoldiers));
            }
        }

        // Load soldiers data for autocomplete
        function loadSoldiers() {
            try {
                // Ensure we have sample data if no soldiers exist
                initializeSampleSoldiers();
                
                // Get soldiers from localStorage
                const soldiers = JSON.parse(localStorage.getItem('soldiers')) || [];
                
                // Update the total soldiers counter
                updateTotalSoldiersCounter();
                
                // Load soldiers into search datalists
                loadSoldiersForSearch();
                
                // Log the number of loaded soldiers for debugging
                console.log(`Loaded ${soldiers.length} soldiers for autocomplete`);
            } catch (error) {
                console.error('Error loading soldiers:', error);
            }
        }
        
        // Fill soldier data when a name is selected
        function fillSoldierData(formType) {
            try {
                const soldiers = JSON.parse(localStorage.getItem('soldiers')) || [];
                const nameInput = document.getElementById(formType === 'absence' ? 'soldierName' : 'leaveSoldierName');
                const selectedSoldier = soldiers.find(s => s.name === nameInput.value);
                
                if (selectedSoldier) {
                    if (formType === 'absence') {
                        document.getElementById('rank').value = selectedSoldier.rank || '';
                        document.getElementById('unit').value = selectedSoldier.unit || '';
                    } else {
                        document.getElementById('leaveRank').value = selectedSoldier.rank || '';
                        document.getElementById('leaveUnit').value = selectedSoldier.unit || '';
                    }
                } else {
                    // Clear fields if no matching soldier is found
                    if (formType === 'absence') {
                        document.getElementById('rank').value = '';
                        document.getElementById('unit').value = '';
                    } else {
                        document.getElementById('leaveRank').value = '';
                        document.getElementById('leaveUnit').value = '';
                    }
                }
            } catch (error) {
                console.error('Error filling soldier data:', error);
            }
        }
        
        // Function to update total soldiers counter with visual feedback
        function updateTotalSoldiersCounter() {
            try {
                const soldiers = JSON.parse(localStorage.getItem('soldiers')) || [];
                const counterElement = document.getElementById('totalSoldiersCounter');
                if (counterElement) {
                    // Remove any existing animation class
                    counterElement.classList.remove('updated');
                    
                    // Force reflow to reset animation
                    void counterElement.offsetWidth;
                    
                    // Update the counter value
                    counterElement.textContent = soldiers.length.toLocaleString('ar-EG');
                    
                    // Add animation class
                    counterElement.classList.add('updated');
                    
                    // Remove the animation class after it completes
                    setTimeout(() => {
                        counterElement.classList.remove('updated');
                    }, 500);
                }
            } catch (error) {
                console.error('Error updating soldiers counter:', error);
            }
        }

        // Get the current week's start and end dates
        function getCurrentWeekRange() {
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const startDate = new Date(now);
            startDate.setDate(now.getDate() - currentDay + (currentDay === 0 ? -6 : 1)); // Start on Monday
            
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // End on Sunday
            
            return { startDate, endDate };
        }
        
        // Format date as YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Validate weekly date range (max 7 days)
        function validateDateRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end dates
            
            if (diffDays > 7) {
                alert('تکایە ماوەی کەمتر لە ٧ ڕۆژ هەڵبژێرە!');
                return false;
            }
            return true;
        }
        
        // Update weekly date range and validate
        function updateWeeklyDateRange(isStartDateChanged = false) {
            const startDateInput = document.getElementById('weeklyStartDate');
            const endDateInput = document.getElementById('weeklyEndDate');
            
            if (!startDateInput.value) {
                return;
            }
            
            // If start date changed, automatically set end date to 7 days later
            if (isStartDateChanged || !endDateInput.value) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6); // 6 days after start date = 7 days total
                
                // Format the end date as YYYY-MM-DD
                const endDateStr = endDate.toISOString().split('T')[0];
                endDateInput.value = endDateStr;
            }
            
            // Generate report with the date range
            generateWeeklyReport();
        }
        
        // Initialize weekly report date range
        function initWeeklyReportDates() {
            const { startDate, endDate } = getCurrentWeekRange();
            const startDateStr = formatDate(startDate);
            const endDateStr = formatDate(endDate);
            
            document.getElementById('weeklyStartDate').value = startDateStr;
            document.getElementById('weeklyEndDate').value = endDateStr;
            
            // Trigger initial report generation
            setTimeout(() => generateWeeklyReport(), 100);
        }
        
        // Generate weekly report
        function generateWeeklyReport() {
            const startDate = document.getElementById('weeklyStartDate').value;
            const endDate = document.getElementById('weeklyEndDate').value;
            const unit = document.getElementById('weeklyReportUnit').value;
            
            if (!startDate || !endDate) {
                alert('تکایە هەردوو بەرواری دەستپێک و کۆتایی دیاری بکەن');
                return;
            }
            
            // Show loading state
            const reportTbody = document.getElementById('weeklyReportTableBody');
            if (reportTbody) {
                reportTbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">لە هەوڵی بەدەستهێنانی زانیارییەکان... <i class="fas fa-spinner fa-spin"></i></td></tr>';
            }
            
            // Update summary cards with loading state
            document.getElementById('weeklyTotalSoldiers').textContent = '...';
            document.getElementById('weeklyTotalAbsences').textContent = '...';
            document.getElementById('weeklyTotalLeaves').textContent = '...';
            document.getElementById('weeklyAbsenceRate').textContent = '...%';
            
            // Get all records from localStorage
            let allRecords = [];
            try {
                allRecords = JSON.parse(localStorage.getItem('militaryRecords')) || [];
            } catch (e) {
                console.error('Error parsing records:', e);
                allRecords = [];
            }
            
            // Filter records for the selected date range and unit
            const filteredRecords = allRecords.filter(record => {
                try {
                    if (!record || !record.dataDate) return false;
                    
                    // Parse the record date
                    let recordDateStr = record.dataDate.split(' ')[0];
                    recordDateStr = recordDateStr.replace(/\//g, '-');
                    
                    const recordDate = new Date(recordDateStr);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    // Check if record date is within the selected range
                    const isInDateRange = recordDate >= start && recordDate <= end;
                    const isMatchingUnit = unit === 'همه' || !unit || record.unit === unit;
                    
                    return isInDateRange && isMatchingUnit;
                } catch (e) {
                    console.error('Error processing record:', record, e);
                    return false;
                }
            });
            
            // Group records by soldier
            const soldiersData = {};
            
            filteredRecords.forEach(record => {
                if (!record.name) return;
                
                if (!soldiersData[record.name]) {
                    soldiersData[record.name] = {
                        name: record.name,
                        rank: record.rank || 'نەناسراو',
                        unit: record.unit || 'نەناسراو',
                        absences: 0,
                        leaves: 0,
                        notes: []
                    };
                }
                
                if (record.type === 'absence') {
                    soldiersData[record.name].absences++;
                } else if (record.type === 'leave') {
                    soldiersData[record.name].leaves++;
                }
                
                if (record.notes && !soldiersData[record.name].notes.includes(record.notes)) {
                    soldiersData[record.name].notes.push(record.notes);
                }
            });
            
            // Convert to array and filter by unit if specified
            let filteredData = Object.values(soldiersData);
            
            if (unit && unit !== 'همه') {
                filteredData = filteredData.filter(soldier => soldier.unit === unit);
            }
            
            // Calculate totals
            const totalSoldiers = filteredData.length;
            const totalAbsences = filteredData.reduce((sum, item) => sum + item.absences, 0);
            const totalLeaves = filteredData.reduce((sum, item) => sum + item.leaves, 0);
            const totalDays = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24) + 1;
            const avgAbsenceRate = totalSoldiers > 0 ? 
                Math.round((totalAbsences / (totalSoldiers * totalDays)) * 100) : 0;
            
            // Update summary cards
            document.getElementById('weeklyTotalSoldiers').textContent = totalSoldiers.toLocaleString('ar-EG');
            document.getElementById('weeklyTotalAbsences').textContent = totalAbsences.toLocaleString('ar-EG');
            document.getElementById('weeklyTotalLeaves').textContent = totalLeaves.toLocaleString('ar-EG');
            document.getElementById('weeklyAbsenceRate').textContent = `${avgAbsenceRate}%`;
            
            // Update report table
            const reportTableBody = document.getElementById('weeklyReportTableBody');
            if (!reportTableBody) {
                console.error('Could not find weekly report table body');
                return;
            }
            
            // Show no results message if no data
            if (filteredData.length === 0) {
                reportTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem; color: #64748b;">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                            هیچ زانیارییەک لەم ماوەیەدا نەدۆزرایەوە
                        </td>
                    </tr>`;
                return;
            }
            
            // Sort by name
            filteredData.sort((a, b) => a.name.localeCompare(b.name, 'ku'));
            
            // Clear and rebuild table
            reportTableBody.innerHTML = '';
            
            filteredData.forEach(soldier => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                row.innerHTML = `
                    <td style="padding: 0.8rem;">${soldier.name}</td>
                    <td style="padding: 0.8rem;">${soldier.rank}</td>
                    <td style="padding: 0.8rem;">${soldier.unit}</td>
                    <td style="padding: 0.8rem; text-align: center; color: ${soldier.absences > 0 ? 'var(--secondary)' : 'inherit'}">
                        ${soldier.absences}
                    </td>
                    <td style="padding: 0.8rem; text-align: center; color: ${soldier.leaves > 0 ? 'var(--leave)' : 'inherit'}">
                        ${soldier.leaves}
                    </td>
                    <td style="padding: 0.8rem; text-align: center;">
                        ${totalDays - (soldier.absences + soldier.leaves)}
                    </td>
                    <td style="padding: 0.8rem;">
                        ${soldier.notes.filter(n => n && n.trim() !== '').join('، ') || '-'}
                    </td>
                `;
                reportTableBody.appendChild(row);
            });
            
            // Update active filters
            updateWeeklyActiveFilters({
                startDate: startDate,
                endDate: endDate,
                unit: unit === 'همه' ? '' : unit
            });
        }
        
        // Update weekly active filters display
        function updateWeeklyActiveFilters({startDate, endDate, unit}) {
            const container = document.getElementById('weeklyActiveFiltersContainer');
            if (!container) return;
            
            container.innerHTML = '';
            container.style.display = 'block';
            
            // Create filters title
            const title = document.createElement('h4');
            title.style.margin = '0 0 0.75rem 0';
            title.style.color = '#475569';
            title.style.fontSize = '0.95rem';
            title.style.fontWeight = '500';
            title.textContent = 'فلتەرە هەڵبژێردراوەکان:';
            container.appendChild(title);
            
            // Create filter badges container
            const badgesContainer = document.createElement('div');
            badgesContainer.style.display = 'flex';
            badgesContainer.style.flexWrap = 'wrap';
            badgesContainer.style.gap = '0.5rem';
            
            // Add date range filter badge
            if (startDate && endDate) {
                const start = new Date(startDate).toLocaleDateString('ar-EG');
                const end = new Date(endDate).toLocaleDateString('ar-EG');
                const dateBadge = createFilterBadge('ماوە', `${start} - ${end}`, 'dateRange');
                badgesContainer.appendChild(dateBadge);
            }
            
            // Add unit filter badge
            if (unit) {
                const unitBadge = createFilterBadge('یەکە', unit, 'unit');
                badgesContainer.appendChild(unitBadge);
            }
            
            container.appendChild(badgesContainer);
        }
        
        // Reset weekly report filters
        function resetWeeklyReportFilters() {
            // Reset date range to current week
            initWeeklyReportDates();
            
            // Reset unit filter
            const unitSelect = document.getElementById('weeklyReportUnit');
            if (unitSelect) {
                unitSelect.selectedIndex = 0;
            }
            
            // Regenerate report
            generateWeeklyReport();
        }
        
        // Print weekly report
        function printWeeklyReport() {
            const printContent = document.getElementById('weeklyReportContainer').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <div style="padding: 20px; font-family: 'Tajawal', 'Arial', sans-serif;">
                    <h1 style="text-align: center; margin-bottom: 20px;">ڕاپۆرتی هەفتانەی غیاب و مۆڵەت</h1>
                    <div id="printContent">${printContent}</div>
                </div>
            `;
            
            // Hide buttons in print view
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => button.style.display = 'none');
            
            window.print();
            document.body.innerHTML = originalContent;
            // Regenerate the report after printing
            generateWeeklyReport();
        }
        
        // Helper function to create a filter badge
        function createFilterBadge(label, value, filterType) {
            const badge = document.createElement('div');
            badge.style.display = 'inline-flex';
            badge.style.alignItems = 'center';
            badge.style.padding = '0.35rem 0.75rem';
            badge.style.borderRadius = '9999px';
            badge.style.backgroundColor = '#f1f5f9';
            badge.style.color = '#334155';
            badge.style.fontSize = '0.85rem';
            badge.style.gap = '0.5rem';
            badge.innerHTML = `
                <span style="font-weight: 500;">${label}:</span>
                <span>${value}</span>
                <button type="button" onclick="removeFilter('${filterType}')" style="background: none; border: none; color: #94a3b8; cursor: pointer; padding: 0.25rem; margin-right: -0.25rem; border-radius: 50%; transition: all 0.2s;" 
                    onmouseover="this.style.backgroundColor='#e2e8f0'; this.style.color='#64748b'" 
                    onmouseout="this.style.backgroundColor='transparent'; this.style.color='#94a3b8'"
                    title="لابردنی فلتەر">
                    <i class="fas fa-times" style="font-size: 0.75rem;"></i>
                </button>
            `;
            return badge;
        }

        // Profile Section Functions
        function initializeProfile() {
            // Load profile data if exists
            const savedProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            if (savedProfile.username) {
                loadProfileData(savedProfile);
            }
            
            // Set up profile image upload
            document.getElementById('profileUpload').addEventListener('change', handleProfileImageUpload);
        }
        
        function loadProfileData(profile) {
            document.getElementById('profileName').textContent = profile.fullName || profile.username || 'ناوی بەکارهێنەر';
            document.getElementById('fullName').value = profile.fullName || '';
            document.getElementById('email').value = profile.email || '';
            document.getElementById('phoneNumber').value = profile.phone || '';
            
            if (profile.profileImage) {
                document.getElementById('profileImage').src = profile.profileImage;
            }
        }
        
        function checkProfilePassword() {
            const password = prompt("تکایە وشەی نهێنی پڕۆفایل بنووسە:", "");
            if (password === "1234") { // Replace with your desired password
                showProfileSection();
            } else if (password !== null) {
                alert("وشەی نهێنی هەڵەیە! تکایە دووبارە هەوڵبدەرەوە.");
            }
        }
        
        function showProfileSection() {
            document.getElementById('profileOverlay').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('profileOverlay').classList.add('active');
            }, 10);
        }
        
        function hideProfileSection() {
            document.getElementById('profileOverlay').classList.remove('active');
            setTimeout(() => {
                document.getElementById('profileOverlay').style.display = 'none';
            }, 300);
        }
        
        function showProfileTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.profile-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab and activate tab button
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        function handleProfileImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                const profileImage = document.getElementById('profileImage');
                profileImage.src = imageUrl;
                
                // Save to profile
                const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                profile.profileImage = imageUrl;
                localStorage.setItem('userProfile', JSON.stringify(profile));
                
                showMessage('وێنەی پرۆفایل بەسەرکەوتوویی نوێکرایەوە', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        function saveProfile() {
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phoneNumber').value;
            
            // Get existing profile or create new one
            const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            
            // Update profile data
            profile.fullName = fullName;
            profile.email = email;
            profile.phone = phone;
            
            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(profile));
            
            // Update displayed name
            document.getElementById('profileName').textContent = fullName || 'ناوی بەکارهێنەر';
            
            showMessage('زانیارییەکان بەسەرکەوتوویی پاشەکەوتکران', 'success');
        }
        
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageElement = document.getElementById('passwordMessage');
            
            // Simple validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                messageElement.textContent = 'تکایە هەموو خانەکان پڕ بکەرەوە';
                messageElement.style.color = '#e74c3c';
                return;
            }
            
            // Get the current user's role from sessionStorage
            const userRole = sessionStorage.getItem('userRole');
            
            // Define valid users and their current passwords
            const validUsers = {
                "admin": "12345",
                "user": "1234"
            };
            
            // Get the current username based on role
            const currentUsername = userRole === 'admin' ? 'admin' : 'user';
            
            // Verify current password
            if (validUsers[currentUsername] !== currentPassword) {
                messageElement.textContent = 'وشەی نهێنی ئێستا هەڵەیە';
                messageElement.style.color = '#e74c3c';
                return;
            }
            
            if (newPassword.length < 4) {
                messageElement.textContent = 'وشەی نهێنی نوێ دەبێت کەمتر لە ٤ پیتی نەبێت';
                messageElement.style.color = '#e74c3c';
                return;
            }
            
            if (newPassword !== confirmPassword) {
                messageElement.textContent = 'وشەی نهێنی نوێ و دووبارەکەرەوەی جیاوازن';
                messageElement.style.color = '#e74c3c';
                return;
            }
            
            try {
                // Update the password in sessionStorage
                sessionStorage.setItem('password', newPassword);
                
                // Show success message
                messageElement.textContent = 'وشەی نهێنی بەسەرکەوتوویی گۆڕا';
                messageElement.style.color = '#27ae60';
                
                // Clear fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                // Update the login page to use the new password
                updateLoginPassword(currentUsername, newPassword);
                
                // Hide message after 3 seconds
                setTimeout(() => {
                    messageElement.textContent = '';
                }, 3000);
            } catch (error) {
                console.error('Error updating password:', error);
                messageElement.textContent = 'هەڵەیەک ڕوویدا لە کاتی نوێکردنەوەی وشەی نهێنی';
                messageElement.style.color = '#e74c3c';
            }
        }
        
        function updateLoginPassword(username, newPassword) {
            // This function would typically make an API call to update the password on the server
            // For this demo, we'll just store it in localStorage as a temporary solution
            const updatedPasswords = JSON.parse(localStorage.getItem('updatedPasswords') || '{}');
            updatedPasswords[username] = newPassword;
            localStorage.setItem('updatedPasswords', JSON.stringify(updatedPasswords));
            
            console.log(`Password updated for ${username} in localStorage`);
        }
        
        function exportData() {
            try {
                // Get all data from localStorage
                const data = {
                    soldiers: JSON.parse(localStorage.getItem('soldiers') || '[]'),
                    records: JSON.parse(localStorage.getItem('records') || '[]'),
                    users: JSON.parse(localStorage.getItem('users') || '[]'),
                    exportDate: new Date().toISOString()
                };
                
                // Create a blob with the data
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create a download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `soldiers_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showMessage('زانیارییەکان بەسەرکەوتوویی هەنرێنرانە دەرەوە', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showMessage('هەڵەیەک ڕوویدا لە کاتی هەناردەکردنی زانیارییەکان', 'error');
            }
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (confirm('ئایا دڵنیایت لە هێنانەوەی زانیارییەکان؟ ئەم کارە زانیارییەکانی پێشوو دەسڕێتەوە!')) {
                        // Save the imported data to localStorage
                        if (data.soldiers) localStorage.setItem('soldiers', JSON.stringify(data.soldiers));
                        if (data.records) localStorage.setItem('records', JSON.stringify(data.records));
                        if (data.users) localStorage.setItem('users', JSON.stringify(data.users));
                        
                        showMessage('زانیارییەکان بەسەرکەوتوویی هێنرانەوە', 'success');
                        
                        // Reload the page to reflect changes
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    showMessage('هەڵەیەک ڕوویدا لە کاتی خوێندنەوەی فایلەکە', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset the file input to allow re-uploading the same file
            event.target.value = '';
        }
        
        function showMessage(message, type = 'error') {
            const elementId = type === 'error' ? 'errorMessage' : 'backupMessage';
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.style.color = type === 'error' ? '#e74c3c' : '#27ae60';
            
            // Hide message after 5 seconds
            setTimeout(() => {
                messageElement.textContent = '';
            }, 5000);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved records and soldiers
            loadRecordsFromStorage();
            loadSoldiersForSearch();

            const userRole = sessionStorage.getItem('userRole');

            if (userRole === 'user') {
                 // Hide action buttons in the table after loading
                const actionButtons = document.querySelectorAll('.action-btn');
                actionButtons.forEach(button => {
                    button.style.display = 'none';
                });
                 // Hide action header in the table
                const actionHeader = document.querySelector('#mainTable th:last-child');
                if(actionHeader) {
                    actionHeader.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>